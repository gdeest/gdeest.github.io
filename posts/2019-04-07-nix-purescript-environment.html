<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <title>Ga√´l Deest - Nix-based PureScript environment</title>
        <link rel="stylesheet" type="text/css" href="../css/default.css" />
        <script type="text/x-mathjax-config">
         MathJax.Hub.Config({ TeX: { extensions: ["AMScd.js"] }});
        </script>
        <link rel="stylesheet" href="../css/highlight/atelier-plateau-light.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
        <script src="../js/highlight.pack.js"></script>
        <script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body>
        <div id="header">
            <div id="logo">
                <a href="../">Ga√´l Deest</a>
            </div>
            <div id="navigation">
                <a href="../">Home</a>
                <a href="../contact.html">Contact</a>
                <a href="../archive.html">Archive</a>
            </div>
        </div>

        <div id="content">
            <h1>Nix-based PureScript environment</h1>

            <div class="info">
    Posted on April  7, 2019
    
        by Ga√´l Deest
    
</div>

<p>This post describes how to quickly setup a PureScript project with Nix, based on <a href="https://github.com/justinwoo/easy-purescript-nix">easy-purescript-nix</a>. These rough notes are mostly intended for myself, but published in the hope that they might be useful to someone else as well.</p>
<p>If you are only interested in the end result, you can find a project skeleton <a href="https://github.com/gdeest/purescript-skeleton">on GitHub</a>.</p>
<h2 id="step-1-install-niv">Step 1: Install niv</h2>
<p>I have fallen in love with <a href="https://github.com/nmattia/niv">niv</a> for managing external dependencies in Nix projects. Here I only use it to provision easy-purescript-nix, so this is a bit overkill. Still, it comes with a sensible project structure and makes it so easy to add/drop/update dependencies, all pinned to specific revisions (including nixpkgs), that I don‚Äôt see any reason not to use it. Moreover:</p>
<ul>
<li>While you don‚Äôt know it today, you might need other dependencies later on.</li>
<li>You can always use niv to set up the initial project and drop the dependence after the fact, then tweaking the generated nix files to your heart‚Äôs content. It is all very simple ; you are not really committing to particular tool or philosophy.</li>
</ul>
<p>You can install niv with:</p>
<pre class="text"><code>$ nix-env -iA niv -f https://github.com/nmattia/niv/tarball/master</code></pre>
<h2 id="step-2-create-the-niv-project">Step 2: Create the niv project</h2>
<p>Once niv is installed, you can create a project with:</p>
<pre class="text"><code>$ mkdir project-skeleton
$ cd project-skeleton
$ niv init</code></pre>
<p>(Of course, you should replace <code>project-skeleton</code> with the name of your project).</p>
<h2 id="step-3-add-the-easy-purescript-nix-dependence">Step 3: Add the easy-purescript-nix dependence</h2>
<p>Then, add the easy-purescript-nix dependence with:</p>
<pre class="text"><code>$ niv add justinwoo/easy-purescript-nix</code></pre>
<p>niv should automatically use the latest revision from the <code>master</code> branch, and pin it in <code>nix/versions.json</code>.</p>
<h2 id="step-4-add-tools-to-shell.nix">Step 4: Add tools to <code>shell.nix</code></h2>
<p>The default <code>shell.nix</code> file generated by niv should look something like this:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="cf">with</span> { pkgs <span class="op">=</span> <span class="im">import</span> .<span class="op">/</span>nix {}<span class="op">;</span> }<span class="op">;</span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2">pkgs.mkShell</a>
<a class="sourceLine" id="cb4-3" data-line-number="3">  { buildInputs <span class="op">=</span> [ pkgs.niv ]<span class="op">;</span></a>
<a class="sourceLine" id="cb4-4" data-line-number="4">  }</a></code></pre></div>
<p>To work on PureScript project, we will need:</p>
<ul>
<li><code>purs</code>, the PureScript compiler.</li>
<li><code>spago</code>, a tool to manage and override PureScript dependencies.</li>
<li><code>node</code>, in order to run the compiled JavaScript code.</li>
</ul>
<p>(Note: you might want to remove the nodejs dependence later on, but we will keep it for now to check that everything went fine. Even if you are working on client-side code, the node runtime might prove useful to run tests and such.)</p>
<p>We can do this by modifying the file to:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="cf">with</span> rec</a>
<a class="sourceLine" id="cb5-2" data-line-number="2">  { pkgs <span class="op">=</span> <span class="im">import</span> .<span class="op">/</span>nix {}<span class="op">;</span></a>
<a class="sourceLine" id="cb5-3" data-line-number="3">    sources <span class="op">=</span> <span class="im">import</span> .<span class="op">/</span>nix<span class="op">/</span>sources.nix<span class="op">;</span></a>
<a class="sourceLine" id="cb5-4" data-line-number="4">    easyPS <span class="op">=</span> (<span class="im">import</span> sources.easy<span class="op">-</span>purescript<span class="op">-</span>nix).inputs<span class="op">;</span></a>
<a class="sourceLine" id="cb5-5" data-line-number="5">  }<span class="op">;</span></a>
<a class="sourceLine" id="cb5-6" data-line-number="6">pkgs.mkShell</a>
<a class="sourceLine" id="cb5-7" data-line-number="7">  { buildInputs <span class="op">=</span> [ pkgs.niv pkgs.nodejs easyPS.purs easyPS.spago ]<span class="op">;</span></a>
<a class="sourceLine" id="cb5-8" data-line-number="8">  }</a></code></pre></div>
<p>(Alternatively, we could define an overlay in <code>nix/default.nix</code>.)</p>
<p>If all went well, you should be able to enter the nix environment by typing:</p>
<pre class="text"><code>$ nix-shell</code></pre>
<p>We can check that the requested tools are indeed in scope:</p>
<pre class="text"><code>$ purs --version
0.12.3

$ spago version
0.7.2.0

$ node --version
v8.15.1</code></pre>
<p>We are almost ready to go!</p>
<h2 id="step-5-initialize-purescript-project-with-spago">Step 5: Initialize PureScript project with spago</h2>
<p>From within the <code>nix-shell</code>, enter the following command:</p>
<pre class="text"><code>$ spago init
Set up a local Spago project.
Try running `spago install`</code></pre>
<p>This command initializes a bare PureScript project. It creates a dummy <code>src/Main.purs</code> file which looks like this:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="kw">module</span> <span class="dt">Main</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb9-2" data-line-number="2"></a>
<a class="sourceLine" id="cb9-3" data-line-number="3"><span class="kw">import</span> <span class="dt">Prelude</span></a>
<a class="sourceLine" id="cb9-4" data-line-number="4"></a>
<a class="sourceLine" id="cb9-5" data-line-number="5"><span class="kw">import</span> <span class="dt">Effect</span> (<span class="dt">Effect</span>)</a>
<a class="sourceLine" id="cb9-6" data-line-number="6"><span class="kw">import</span> <span class="dt">Effect.Console</span> (log)</a>
<a class="sourceLine" id="cb9-7" data-line-number="7"></a>
<a class="sourceLine" id="cb9-8" data-line-number="8"><span class="ot">main ::</span> <span class="dt">Effect</span> <span class="dt">Unit</span></a>
<a class="sourceLine" id="cb9-9" data-line-number="9">main <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb9-10" data-line-number="10">  log <span class="st">&quot;üçù&quot;</span></a></code></pre></div>
<p>For testing purposes, I suggest that you change üçù (the emoticon for spaghettis) to something that displays well in a terminal (I will just use ‚ÄúHello world!‚Äù).</p>
<p><code>spago init</code> also creates a <code>packages.dhall</code> file where you can declare PureScript dependencies. You can install said dependencies in your local environment with <code>spago install</code>:</p>
<pre class="text"><code>$ spago install
Installing 3 dependencies.
Installing &quot;prelude&quot;
Installing &quot;console&quot;
Installing &quot;effect&quot;
Installation complete.</code></pre>
<p>You should re-run this command whenever you make changes to <code>package.dhall</code>.</p>
<p>Finally, you can compile the PureScript program to some <code>index.js</code> file with <code>spago bundle</code>:</p>
<pre class="text"><code>$ spago bundle
Installation complete.
Build succeeded.
Bundle succeeded and output file to index.js</code></pre>
<p>There are different ways to build/bundle/package your code, I encourage you to read <a href="https://github.com/spacchetti/spago#building-and-testing-a-project">the documentation</a> for further details.</p>
<h2 id="step-6-check-that-everything-works">Step 6: Check that everything works</h2>
<p>To check that everything went well, just run the output JavaScript with <code>node</code>:</p>
<pre class="text"><code>$ node index.js
Hello, world!</code></pre>
<p>You are ready to go !</p>

<div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = '//gdeest.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

        </div>
        <div id="footer">
            Site proudly generated by
            <a href="http://jaspervdj.be/hakyll">Hakyll</a>
        </div>
    </body>
    <script type="text/javascript">hljs.initHighlightingOnLoad();</script>
    <script type="text/javascript">
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-88735265-1', 'auto');
        ga('send', 'pageview');
    </script>
</html>
