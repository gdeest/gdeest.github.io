<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <title>Ga√´l Deest - Nix-based PureScript environment</title>
        <link rel="stylesheet" type="text/css" href="../css/default.css" />
        <script type="text/x-mathjax-config">
         MathJax.Hub.Config({ TeX: { extensions: ["AMScd.js"] }});
        </script>
        <link rel="stylesheet" href="../css/highlight/atelier-plateau-light.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
        <script src="../js/highlight.pack.js"></script>
        <script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body>
        <div id="header">
            <div id="logo">
                <a href="../">Ga√´l Deest</a>
            </div>
            <div id="navigation">
                <a href="../">Home</a>
                <a href="../contact.html">Contact</a>
                <a href="../archive.html">Archive</a>
            </div>
        </div>

        <div id="content">
            <h1>Nix-based PureScript environment</h1>

            <div class="info">
    Posted on April  7, 2019
    
        by Ga√´l Deest
    
</div>

<p>This post describes how to quickly setup a PureScript project with Nix, based on <a href="https://github.com/justinwoo/easy-purescript-nix">easy-purescript-nix</a>. These rough notes are mostly intended for myself, but published in the hope that they might be useful to someone else as well.</p>
<p>If you are only interested in the end result, you can find a project skeleton <a href="https://github.com/gdeest/purescript-skeleton">on GitHub</a>.</p>
<h2 id="step-1-install-niv">Step 1: Install niv</h2>
<p>I have fallen in love with <a href="https://github.com/nmattia/niv">niv</a> for managing external dependencies in Nix projects. Here I only use it to provision <code>easy-purescript-nix</code>, so this is a bit overkill. Still, it comes with a sensible project structure and makes it so easy to add/drop dependencies pinned to specific revisions, including the <code>nixpkgs</code> repository itself, that I don‚Äôt see any reason not to use it.</p>
<p>You can install niv with:</p>
<pre><code>$ nix-env -iA niv -f https://github.com/nmattia/niv/tarball/master</code></pre>
<h2 id="step-2-create-niv-project">Step 2: Create niv project</h2>
<p>Once <code>niv</code> is installed, you can create a project with:</p>
<pre><code>$ mkdir project-skeleton
$ cd project-skeleton
$ niv init</code></pre>
<p>(Of course, you should replace <code>project-skeleton</code> with the name of your project).</p>
<h2 id="step-3-add-easy-purescript-nix-dependence">Step 3: Add easy-purescript-nix dependence</h2>
<p>Then, add the <code>easy-purescript-nix</code> dependence with:</p>
<pre><code>$ niv add justinwoo/easy-purescript-nix</code></pre>
<p>niv should automatically use the latest revision from the <code>master</code> branch, and pin it in <code>nix/versions.json</code>.</p>
<h2 id="step-4-add-purs-and-spago-to-shell.nix">Step 4: Add purs and spago to <code>shell.nix</code></h2>
<p>The default <code>shell.nix</code> generated by niv should look something like this:</p>
<pre><code>with { pkgs = import ./nix {}; };
pkgs.mkShell
  { buildInputs = [ pkgs.niv ];
  }</code></pre>
<p>To work on PureScript project, we will need:</p>
<ul>
<li><code>purs</code>, the PureScript compiler.</li>
<li><code>spago</code>, a tool to manage and override PureScript dependencies.</li>
<li><code>node</code>, in order to run the compiled JavaScript code.</li>
</ul>
<p>(Note: you might want to remove the <code>nodejs</code> dependence later on, but we will keep it for now to check that everything went fine. Even if you are working on client-side code, <code>node</code> might be useful to run tests, etc.)</p>
<p>We can do this by modifying the file to:</p>
<pre><code>with rec
  { pkgs = import ./nix {};
    sources = import ./nix/sources.nix;
    easyPS = (import sources.easy-purescript-nix).inputs;
  };
pkgs.mkShell
  { buildInputs = [ pkgs.niv pkgs.nodejs easyPS.purs easyPS.spago ];
  }</code></pre>
<p>(Alternatively, we could define an overlay in <code>nix/default.nix</code>.)</p>
<p>If all went well, you should be able to enter the <code>nix</code> environment by typing:</p>
<pre><code>$ nix-shell</code></pre>
<p>Check that the tools are indeed in scope:</p>
<pre><code>$ purs --version
0.12.3

$ spago version
0.7.2.0

$ node --version
v8.15.1</code></pre>
<p>If such is the case, you are almost ready to go.</p>
<h2 id="step-5-initialize-purescript-project-with-spago">Step 5: Initialize PureScript project with spago</h2>
<p>From within the <code>nix-shell</code>, enter the following commands:</p>
<pre><code>$ spago init
Set up a local Spago project.
Try running `spago install`

$ spago install
Installing 3 dependencies.
Installing &quot;prelude&quot;
Installing &quot;console&quot;
Installing &quot;effect&quot;
Installation complete.</code></pre>
<p>The first one initializes a bare PureScript project. It creates a <code>src/Main.purs</code> file which looks like this:</p>
<pre><code>module Main where

import Prelude

import Effect (Effect)
import Effect.Console (log)

main :: Effect Unit
main = do
  log &quot;üçù&quot;</code></pre>
<p>I suggest that you change üçù (the emoticon for spaghettis) to something that prints well in a terminal for testing purposes (I will just use ‚ÄúHello world!‚Äù).</p>
<p><code>spago init</code> also creates a <code>package.dhall</code> file where you can declare PureScript dependencies. <code>spago install</code> installs said dependencies ; you should re-run this command whenever you make changes to <code>package.dhall</code>.</p>
<p>Finally, you can compile the program to some <code>index.js</code> file with:</p>
<pre><code>$ spago bundle
Installation complete.
Build succeeded.
Bundle succeeded and output file to index.js</code></pre>
<p>(There are different ways to build/bundle/package your code, I encourage you to read the documentation for further details.)</p>
<h2 id="step-6-check-that-everything-works">Step 6: Check that everything works</h2>
<p>To check that everything went well, just run the output JavaScript with <code>node</code>:</p>
<pre><code>$ node index.js
Hello, world!</code></pre>
<p>You are ready to go !</p>

<div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = '//gdeest.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

        </div>
        <div id="footer">
            Site proudly generated by
            <a href="http://jaspervdj.be/hakyll">Hakyll</a>
        </div>
    </body>
    <script type="text/javascript">hljs.initHighlightingOnLoad();</script>
    <script type="text/javascript">
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-88735265-1', 'auto');
        ga('send', 'pageview');
    </script>
</html>
